<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fermah Quiz</title>
<meta name="theme-color" content="#0b1b22"/>
<style>
  :root{--bg:#0b1b22;--panel:#0e252e;--ink:#e8f6f2;--muted:#9fc6bb;--accent:#17c8a5;--good:#1fd38f;--bad:#ff6b6b}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:980px;margin:auto;padding:16px 14px 90px}
  header{display:flex;align-items:center;gap:12px;margin:8px 0 18px}
  .title{font-weight:800;font-size:26px}
  .tag{color:var(--muted);font-size:13px}
  .spacer{flex:1}
  .card{background:linear-gradient(180deg,#0e262f,#0e2127);border:1px solid #13333d;border-radius:14px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:1fr 1fr}
  .btn{background:var(--accent);border:none;color:#062027;font-weight:800;padding:12px 14px;border-radius:12px;cursor:pointer}
  .btn.alt{background:#153943;color:#cdeee7;border:1px solid #24535f}
  .row{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:13px}
  input[type="text"],input[type="password"]{background:#0a1d24;border:1px solid #173842;color:var(--ink);padding:11px 12px;border-radius:10px;outline:none;width:100%}
  input[type="file"]{display:none}
  label.file{display:inline-block;background:#0a1d24;border:1px solid #173842;color:#cdeee7;padding:10px 12px;border-radius:10px;cursor:pointer;white-space:nowrap}
  #fileName{max-width:50vw;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  select{background:#0a1d24;border:1px solid #173842;color:var(--ink);padding:11px 12px;border-radius:10px;outline:none;width:100%}
  .pfp{width:84px;height:84px;border-radius:16px;object-fit:cover;border:1px solid #23444f;background:#0b1e25}
  .qtxt{font-size:20px;font-weight:700;margin:0 0 10px}
  .options{display:grid;gap:10px}
  .option{background:#0a1e25;border:1px solid #183a45;border-radius:12px;padding:12px;cursor:pointer;color:#e8f6f2;text-align:left}
  .option:hover{border-color:#2a5d6b}
  .option.correct{border-color:var(--good);box-shadow:0 0 0 2px rgba(31,211,143,.15)}
  .option.wrong{border-color:var(--bad);box-shadow:0 0 0 2px rgba(255,107,107,.12)}
  .hud{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px}
  .chip{background:#0a1d23;border:1px solid #173741;color:#bfeee4;padding:6px 10px;border-radius:999px;font-size:13px}
  footer{position:fixed;left:0;right:0;bottom:0;padding:10px 14px;text-align:center;color:#96cfc3;background:linear-gradient(180deg,transparent,rgba(0,0,0,.35));font-size:12px}
  footer b{color:#d8fff7}
  .right{justify-self:end}
  @media (max-width:720px){.two{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">Fermah Quiz</div>
      <div class="tag">Test your ZK & Fermah IQ üß†</div>
    </div>
    <div class="spacer"></div>
    <button class="btn alt right" id="logoutBtn" style="display:none">Logout</button>
  </header>

  <!-- LOGIN -->
  <section id="login" class="card grid">
    <div class="grid two">
      <div>
        <div class="muted" style="margin-bottom:6px">Create account</div>
        <div class="grid">
          <input id="name" type="text" placeholder="Username (e.g. FreeGuyx247)"/>
          <div class="row">
            <label class="file" for="pfp">Choose image</label>
            <span id="fileName" class="muted">No image chosen</span>
            <input id="pfp" type="file" accept="image/png,image/jpeg"/>
          </div>
          <input id="passCreate" type="password" placeholder="Password (min 6 chars)"/>
          <button class="btn" id="createBtn">Create & Continue</button>
        </div>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">Or log in</div>
        <div class="grid">
          <select id="loginSelect"></select>
          <input id="passLogin" type="password" placeholder="Password"/>
          <button class="btn alt" id="loginBtn">Login</button>
        </div>
      </div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dash" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="row" style="gap:12px">
        <img id="dPfp" class="pfp" alt="">
        <div>
          <div style="font-weight:800" id="dName"></div>
          <div class="muted" id="dSub"></div>
        </div>
      </div>
      <button class="btn" id="startBtn">Start quiz</button>
    </div>
  </section>

  <!-- QUIZ -->
  <section id="quiz" class="card" style="display:none">
    <div class="hud">
      <span class="chip" id="hudUser"></span>
      <span class="chip">Q <b id="hudIdx">1</b>/<b id="hudTotal">10</b></span>
      <span class="chip">‚úÖ <b id="hudScore">0</b></span>
      <span class="chip">‚è±Ô∏è <b id="hudTime">0s</b></span>
    </div>
    <p class="qtxt" id="question"></p>
    <div class="options" id="options"></div>
  </section>

  <!-- RESULT -->
  <section id="result" class="card" style="display:none">
    <div class="grid two">
      <div class="row" style="gap:12px;align-items:center">
        <img id="resPfp" class="pfp" alt="">
        <div>
          <div style="font-weight:800" id="resName"></div>
          <div class="muted" id="resTag"></div>
        </div>
      </div>
      <div>
        <div class="qtxt">Your Proof-IQ</div>
        <div id="resIQ" style="font-size:40px;font-weight:900;color:#17c8a5"></div>
        <div id="resSummary" class="muted"></div>
      </div>
    </div>

    <div class="grid two" style="margin-top:12px">
      <button class="btn" id="playAgain">Play Again</button>
      <button class="btn alt" id="backDash">Back</button>
    </div>

    <div class="grid two" style="margin-top:12px">
      <button class="btn" id="saveCardBtn">Save Card (PNG)</button>
      <button class="btn alt" id="shareBtn">Share</button>
    </div>
    <a id="dlLink" download="fermah-quiz-card.png" style="display:none"></a>
  </section>
</div>

<footer>Made by <b>FreeGuyx247</b> ‚Ä¢ Community fan project</footer>

<script>
/* ----------------- App State ----------------- */
let currentUser=null, quizSize=10, timerId=null, questions=[], idx=0, score=0, startTs=0;

/* ----------------- Storage Helpers ----------------- */
function loadProfiles(){ try{return JSON.parse(localStorage.getItem('fermah_profiles_v3')||'[]')}catch{return[]} }
function saveProfiles(arr){ localStorage.setItem('fermah_profiles_v3', JSON.stringify(arr)) }
function refreshLogin(){
  const sel=document.getElementById('loginSelect'); sel.innerHTML='';
  loadProfiles().forEach((p,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=p.name; sel.appendChild(o); });
}

/* ----------------- Utils ----------------- */
function fileToDataURL(f){return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(f);});}
function sha256(text){return crypto.subtle.digest('SHA-256', new TextEncoder().encode(text)).then(buf=>[...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join(''));}

/* ----------------- Auth Flow ----------------- */
pfp.onchange=()=>{fileName.textContent=pfp.files[0]?.name||'No image chosen';};

createBtn.onclick=async ()=>{
  const name=nameInput().trim(); if(!name) return alert('Enter a username');
  const pass=document.getElementById('passCreate').value; if(!pass||pass.length<6) return alert('Password must be at least 6 chars');
  const passHash=await sha256(pass);
  const pfpFile=document.getElementById('pfp').files[0];
  const pfp64=pfpFile?await fileToDataURL(pfpFile):'';
  const list=loadProfiles();
  if(list.some(p=>p.name.toLowerCase()===name.toLowerCase())) return alert('Name already exists, use Login.');
  list.push({name, passHash, pfp:pfp64, stats:{bestIQ:0, last:{score:0,total:0,secs:0,iq:0}}});
  saveProfiles(list); refreshLogin(); alert('Account created! Please login.');
};
function nameInput(){return document.getElementById('name').value}

loginBtn.onclick=async ()=>{
  const list=loadProfiles();
  const i=(document.getElementById('loginSelect').value||'0')|0;
  const user=list[i]; if(!user) return alert('Select a profile');
  const hash=await sha256(document.getElementById('passLogin').value||'');
  if(hash!==user.passHash) return alert('Wrong password');
  currentUser=user; showDash();
};
logoutBtn.onclick=()=>{ currentUser=null; showOnly('login'); logoutBtn.style.display='none'; };

/* ----------------- Views ----------------- */
function showOnly(id){['login','dash','quiz','result'].forEach(s=>document.getElementById(s).style.display=(s===id?'block':'none'))}
function showDash(){
  document.getElementById('dName').textContent=currentUser.name;
  document.getElementById('dPfp').src=currentUser.pfp||'';
  const s=currentUser.stats||{bestIQ:0,last:{score:0,total:0,secs:0,iq:0}};
  document.getElementById('dSub').textContent=`Best IQ: ${s.bestIQ||0} ‚Ä¢ Last: ${s.last.score||0}/${s.last.total||0} in ${s.last.secs||0}s (IQ ${s.last.iq||0})`;
  showOnly('dash'); logoutBtn.style.display='inline-block';
}
document.getElementById('backDash').onclick=showDash;

/* ----------------- 100 Fermah Questions ----------------- */
const BANK=[ /* (100 items) */
{q:"What is Fermah at a high level?",a:["A universal market for ZK proofs","A centralized exchange","A password manager","A wallet app"],i:0},
{q:"Who submits proof jobs to Fermah?",a:["Seekers","Miners","Indexers","Auditors"],i:0},
{q:"Who generates proofs for jobs?",a:["Prover Nodes","Validators","Relayers","Wallets"],i:0},
{q:"Who checks proofs on-chain/off-chain?",a:["Verifiers","Provers","Bridges","Sequencers"],i:0},
{q:"Fermah‚Äôs goal for proofs is to make them‚Ä¶",a:["Cheap, fast, and reliable","Costly and exclusive","Chain-locked","Vendor-locked"],i:0},
{q:"‚ÄòCredibly neutral‚Äô in Fermah means‚Ä¶",a:["No vendor/chain bias in the market","One chain is preferred","Private allowlist only","Fixed zkVM only"],i:0},
{q:"Universal proving implies Fermah can handle‚Ä¶",a:["Multiple proof systems, chains, and VMs","Only STARKs","Only Groth16","Only Ethereum"],i:0},
{q:"The Matchmaker component mainly‚Ä¶",a:["Assigns jobs to capable Provers","Collects gas fees","Bridges assets","Runs governance"],i:0},
{q:"Why does a market reduce proof cost?",a:["Higher utilization of prover hardware","Higher gas fees","Bigger L1 blocks","More wallets"],i:0},
{q:"Fermah often referenced with restaking via‚Ä¶",a:["EigenLayer context (AVS)","Cosmos IBC","Bitcoin mining pools","IPFS gateways"],i:0},
{q:"A zkVM is‚Ä¶",a:["A VM whose execution can be proven","A video machine","An exchange VM","A storage engine"],i:0},
{q:"In ZK, a ‚Äòwitness‚Äô is‚Ä¶",a:["Secret inputs to the circuit","Only public inputs","Gas price","Account nonce"],i:0},
{q:"Public inputs are‚Ä¶",a:["Known to the verifier","Always secret","Stored as witness only","Encrypted only"],i:0},
{q:"Zero-knowledge means a proof reveals‚Ä¶",a:["Nothing beyond validity","All inputs","Private keys","Circuit code"],i:0},
{q:"Soundness roughly ensures‚Ä¶",a:["False statements can‚Äôt be proven (negligible)","Proofs are short","Setup is universal","Keys are reusable"],i:0},
{q:"Completeness ensures‚Ä¶",a:["True statements have proofs","Proofs have pairings","Setup is trusted","Witness is hidden"],i:0},
{q:"Fiat‚ÄìShamir turns‚Ä¶",a:["Interactive protocols ‚Üí non-interactive","Hashes ‚Üí commitments","R1CS ‚Üí AIR","PLONK ‚Üí STARK"],i:0},
{q:"A trusted setup creates‚Ä¶",a:["Proving/verification keys","Wallets","Smart contracts","Bridges"],i:0},
{q:"‚ÄòPowers of Tau‚Äô is a‚Ä¶",a:["Common setup ceremony","Hash function","Curve","AIR schema"],i:0},
{q:"Universal setup is‚Ä¶",a:["Reusable across circuits","Per-circuit only","For hashing only","Only for STARKs"],i:0},
{q:"R1CS describes‚Ä¶",a:["Constraints for some SNARKs","Account trees","Gas rules","Rollup batches"],i:0},
{q:"AIR is used by‚Ä¶",a:["STARKs","Groth16","KZG only","ECDSA"],i:0},
{q:"FRI is a protocol used in‚Ä¶",a:["STARKs","Groth16","IPA only","RSA"],i:0},
{q:"KZG commitments power‚Ä¶",a:["PLONK-style SNARKs","FRI STARKs only","ECDSA","RSA"],i:0},
{q:"Groth16 is known for‚Ä¶",a:["Very short proofs","No setup","Huge proofs","No pairings"],i:0},
{q:"BLS12-381 is a‚Ä¶",a:["Pairing-friendly curve","Hash function","VM","Bridge"],i:0},
{q:"BN254 is common in‚Ä¶",a:["Ethereum SNARK tooling","Bitcoin PoW","Only FRI","Only ECDSA"],i:0},
{q:"Poseidon is a‚Ä¶",a:["ZK-friendly hash","Pairing","Curve","Signature"],i:0},
{q:"Merkle trees provide‚Ä¶",a:["Commitment & membership proofs","Consensus","Randomness","Bridging"],i:0},
{q:"Polynomial commitments prove‚Ä¶",a:["Evaluation at a point","Block size","Gas paid","Nonce"],i:0},
{q:"Recursion enables‚Ä¶",a:["Aggregating proofs (proofs of proofs)","No hashing","No circuits","Gasless chains"],i:0},
{q:"Aggregation mainly reduces‚Ä¶",a:["Verifier work/size","Prover time always","Circuit size","Key sizes"],i:0},
{q:"Scheduling matters because‚Ä¶",a:["Matching capability‚Üíjob lowers latency","Hides proofs","Raises gas","Throttles users"],i:0},
{q:"Proving is dominated by‚Ä¶",a:["Compute (CPU/GPU/ASIC)","Disk only","Network only","RPC calls"],i:0},
{q:"Verifiers on L1 should be‚Ä¶",a:["Cheap & deterministic","GPU heavy","Randomized","Off-chain only"],i:0},
{q:"Batching proofs helps‚Ä¶",a:["Amortize costs","Leak secrets","Create inflation","Break soundness"],i:0},
{q:"Validity rollups rely on‚Ä¶",a:["ZK proofs of state transitions","Honest sequencers only","Optimistic disputes","Bridges"],i:0},
{q:"Optimistic rollups rely on‚Ä¶",a:["Fraud proofs & delay","Pairings","Trusted setup","FRI only"],i:0},
{q:"Circuit size affects‚Ä¶",a:["Prover time & memory","Wallet UI only","Gas only","EVM opcodes"],i:0},
{q:"Proof size affects‚Ä¶",a:["Verification cost & bandwidth","Prover RAM only","Witness secrecy","Curve choice only"],i:0},
{q:"PLONK is a‚Ä¶",a:["Universal SNARK family","STARK hash","zkVM","AIR system"],i:0},
{q:"IPA commitments appear in‚Ä¶",a:["SNARKs without pairings","Merkle proofs","ECDSA only","FRI only"],i:0},
{q:"Setup risk is mitigated by‚Ä¶",a:["Multi-party ceremonies","Single operator","Central server","No hashing"],i:0},
{q:"Lookup arguments speed‚Ä¶",a:["Certain SNARK operations","P2P gossip","Bridges","Signature size"],i:0},
{q:"Range proofs prove‚Ä¶",a:["Value within bounds","Ownership","Gas usage","Miners"],i:0},
{q:"A nullifier prevents‚Ä¶",a:["Double-spend/replay","Pairings","Hashing","ECDSA"],i:0},
{q:"Semaphore demonstrates‚Ä¶",a:["Membership privately","Gas paid","Chain ID","Block time"],i:0},
{q:"A universal market helps avoid‚Ä¶",a:["Vendor lock-in","Higher TPS","Lower security","Public inputs"],i:0},
{q:"Time-to-proof improves with‚Ä¶",a:["Right hardware & scheduling","Bigger blocks","Extra RPCs","Longer keys"],i:0},
{q:"Verification key (VK) is used by‚Ä¶",a:["Verifiers","Provers","Relayers","Wallet UI"],i:0},
{q:"Proving key (PK) is used by‚Ä¶",a:["Provers","Verifiers","Bridges","Sequencers"],i:0},
{q:"Witness is kept‚Ä¶",a:["Secret","On-chain","In calldata","Account tree"],i:0},
{q:"Public inputs are typically‚Ä¶",a:["Provided/committed to verifier","Never used","Encrypted only","Random"],i:0},
{q:"A ZK proof should convince verifier‚Ä¶",a:["Statement true without revealing witness","Gas is cheap","Curve is safe","Wallet is rich"],i:0},
{q:"Memory-hard stages mostly hit the‚Ä¶",a:["Prover","Verifier","Wallet","RPC"],i:0},
{q:"STARKs avoid trusted setup with‚Ä¶",a:["FRI + hash commitments","KZG only","Pairings","Multi-sig"],i:0},
{q:"SNARKs often rely on‚Ä¶",a:["Pairings/commitments","FRI only","Bridges","L1 consensus"],i:0},
{q:"Compilation targets for circuits include‚Ä¶",a:["R1CS/PLONKish/AIR","SQL","PNG","WASM UI only"],i:0},
{q:"zkEVM proves‚Ä¶",a:["EVM execution correctness","Wallet balances","Gas burn","Bridged tokens"],i:0},
{q:"On-chain verify gas should be‚Ä¶",a:["Minimized","Maximized","Irrelevant","Unlimited"],i:0},
{q:"Hardware accel for proving includes‚Ä¶",a:["GPU/FPGA/ASIC","Only CPU","Only HDD","Only NIC"],i:0},
{q:"For Seekers, markets bring‚Ä¶",a:["Price discovery & reliability","Hidden costs","Fixed TPS","Direct L1 MEV"],i:0},
{q:"For Provers, markets bring‚Ä¶",a:["Steady demand/utilization","Censorship","KYC wallets","Burning keys"],i:0},
{q:"A circuit bug can break‚Ä¶",a:["Soundness","Completeness only","Hashing only","Calldata size"],i:0},
{q:"Poseidon preferred because‚Ä¶",a:["ZK-friendly arithmetic","Short public keys","Cheap opcodes","No field ops"],i:0},
{q:"Pairings are operations on‚Ä¶",a:["Elliptic-curve groups","Merkle trees","RPC","Sequencers"],i:0},
{q:"ZK-friendly curves include‚Ä¶",a:["BLS12-381 & BN254","secp256k1 only","ed25519 only","P-256 only"],i:0},
{q:"Verifier contracts check‚Ä¶",a:["Proof, public inputs, VK","Wallet seed","Gas token","Chain ID"],i:0},
{q:"Recursion enables checkpoints by‚Ä¶",a:["Rolling many proofs into one","Publishing raw logs","Using faucets","Printing receipts"],i:0},
{q:"Fermah backs reliability of Provers with‚Ä¶",a:["Restaked collateral/reputation","Captchas","Follower counts","Chain IDs"],i:0},
{q:"Latency sensitivity matters most for‚Ä¶",a:["Time-critical proof jobs","Cold storage","Docs","Images"],i:0},
{q:"Throughput increases via‚Ä¶",a:["Parallel proving & batching","Bigger blocks only","Extra RPCs","More signatures"],i:0},
{q:"Capability matching considers‚Ä¶",a:["System, memory, perf & price","PFP image","Twitter handle","L1 slot"],i:0},
{q:"Seeker transparency helps‚Ä¶",a:["Forecasting costs","Front-running","Censorship","Spam"],i:0},
{q:"A proof of solvency shows‚Ä¶",a:["Liabilities ‚â§ assets without leaking balances","TPS","Bridge fees","Seed phrases"],i:0},
{q:"Circuit ‚Äògadgets‚Äô are‚Ä¶",a:["Reusable sub-circuits","Android widgets","Wallet plugins","L1 precompiles"],i:0},
{q:"IPA proofs avoid pairings by‚Ä¶",a:["Inner-product checks","Using FRI","Needing RSA","Patricia tries"],i:0},
{q:"KZG needs setup whereas FRI‚Ä¶",a:["Does not","Also needs SRS","Needs pairings","Needs RSA SRS"],i:0},
{q:"Rollups post data to L1 for‚Ä¶",a:["Data availability","Extra gas","MEV","Bridging"],i:0},
{q:"Arithmetization maps logic to‚Ä¶",a:["Field equations/constraints","Calldata ABI","EVM opcodes only","Solidity"],i:0},
{q:"Constraint system proves relation of‚Ä¶",a:["Inputs & program","Wallet & gas","Chain & slot","Bridge & L2"],i:0},
{q:"Witness generation happens during‚Ä¶",a:["Proving","Verification","Compilation","Deployment"],i:0},
{q:"Verification is typically‚Ä¶",a:["Fast","Slower than proving","Interactive","GPU only"],i:0},
{q:"Recursion/compression reduces‚Ä¶",a:["Chain verify cost","Prover memory always","Circuit size always","Setup size"],i:0},
{q:"Universal market like Fermah reduces‚Ä¶",a:["Vendor lock-in risk","Hash collisions","Key size","Merkle depth"],i:0},
{q:"Multiple systems let Seekers‚Ä¶",a:["Choose cost/latency tradeoffs","Pick 1 forced vendor","Avoid neutrality","Fix gas"],i:0},
{q:"Key inputs for pricing include‚Ä¶",a:["Hardware time & energy","User age","Chat count","Block size only"],i:0},
{q:"Good orchestration lowers‚Ä¶",a:["Tail latency","Bandwidth","Tx count","Nonce"],i:0},
{q:"Artifacts typically shipped as‚Ä¶",a:["Docker images/containers","PDFs","PNGs","Emails"],i:0},
{q:"In Fermah UI a Seeker request becomes‚Ä¶",a:["A job in the market","A block","A bridge","A faucet"],i:0},
{q:"Provers advertise‚Ä¶",a:["Capabilities/price/latency","NFTs","Seeds","Avatars"],i:0},
{q:"Verifiers should be‚Ä¶",a:["Deterministic & cheap","Random","Off-chain only","GPU-heavy"],i:0},
{q:"Transparency avoids‚Ä¶",a:["Unclear/volatile pricing","Too many proofs","Perfect fairness","No hashing"],i:0},
{q:"Fermah discourages vendor lock-in by‚Ä¶",a:["Open market of proof systems","Exclusive contracts","Closed APIs","Single prover"],i:0},
{q:"What does ‚Äòuniversal proving‚Äô unlock for dapps?",a:["Portability across systems/chains","Fixed fees","No audits","No circuits"],i:0},
{q:"What does ‚Äòseparation of concerns‚Äô mean here?",a:["Seekers buy; Provers sell; Verifiers check","Everyone does everything","Only L1s involved","Wallet does proving"],i:0},
{q:"Why publish clear job specs?",a:["Better matching & forecasting","Cosmetics","Spam","To hide costs"],i:0},
{q:"What improves reliability over time?",a:["Reputation/metrics per Prover","Random lotteries","Off-chain secrets","UI themes"],i:0},
{q:"What can be a time bonus factor?",a:["Faster correct answers","Wrong answers","More gas","Bigger blocks"],i:0},
{q:"End-to-end flow is typically‚Ä¶",a:["Seeker ‚Üí Matchmaker ‚Üí Prover ‚Üí Verifier","Miner ‚Üí Faucet ‚Üí Wallet","Bridge ‚Üí Oracle ‚Üí Rollup","User ‚Üí RPC ‚Üí Node"],i:0}
]; // 100 total

/* ----------------- Quiz Engine ----------------- */
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function pickRandom(n,arr=BANK){return shuffle([...arr]).slice(0,n)}
function startQuiz(){
  showOnly('quiz');
  document.getElementById('hudUser').textContent=`üë§ ${currentUser.name}`;
  document.getElementById('hudScore').textContent=0;
  document.getElementById('hudTotal').textContent=quizSize;
  document.getElementById('hudTime').textContent='0s';

  questions=pickRandom(quizSize).map(q=>{
    const opts=q.a.map((t,i)=>({t,i})); shuffle(opts);
    return {q:q.q, opts, correct:opts.findIndex(o=>o.i===q.i)};
  });
  idx=0; score=0; startTs=Date.now();
  if(timerId) clearInterval(timerId);
  timerId=setInterval(()=>document.getElementById('hudTime').textContent=Math.floor((Date.now()-startTs)/1000)+'s',300);
  showQuestion();
}
function showQuestion(){
  if(idx>=questions.length){ endQuiz(); return; }
  document.getElementById('hudIdx').textContent=idx+1;
  const it=questions[idx];
  document.getElementById('question').textContent=it.q;
  const box=document.getElementById('options'); box.innerHTML='';
  it.opts.forEach((o,i)=>{
    const b=document.createElement('button'); b.className='option'; b.textContent=o.t;
    b.onclick=()=>selectAnswer(i,b,it); box.appendChild(b);
  });
}
function selectAnswer(i,btn,it){
  [...document.querySelectorAll('.option')].forEach(x=>x.disabled=true);
  if(i===it.correct){ score++; btn.classList.add('correct'); } else { btn.classList.add('wrong'); }
  document.getElementById('hudScore').textContent=score;
  setTimeout(()=>{ idx++; showQuestion(); },600);
}
function endQuiz(){
  clearInterval(timerId);
  const total=questions.length, secs=Math.max(1,Math.floor((Date.now()-startTs)/1000)), acc=score/total;
  const iq=Math.round(60+40*acc+Math.min(20,200/secs));

  document.getElementById('resName').textContent=currentUser.name;
  document.getElementById('resPfp').src=currentUser.pfp||'';
  document.getElementById('resTag').textContent=`${score}/${total} correct ‚Ä¢ ${secs}s`;
  document.getElementById('resIQ').textContent=iq;
  document.getElementById('resSummary').textContent=`Accuracy ${(acc*100).toFixed(0)}% ‚Ä¢ Time bonus applied`;
  showOnly('result');

  // persist to local stats
  const list=loadProfiles(); const i=list.findIndex(p=>p.name===currentUser.name);
  if(i>-1){
    list[i].stats=list[i].stats||{bestIQ:0,last:{}};
    list[i].stats.bestIQ=Math.max(list[i].stats.bestIQ||0,iq);
    list[i].stats.last={score,total,secs,iq};
    currentUser=list[i]; saveProfiles(list);
  }
  setupShareButtons({score,total,secs,iq});
}

document.getElementById('startBtn').onclick=startQuiz;
document.getElementById('playAgain').onclick=startQuiz;

/* ----------------- Shareable Results Card ----------------- */
function drawRoundedRect(ctx,x,y,w,h,r){
  ctx.beginPath(); ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
}
async function buildCardPNG({score,total,secs,iq}){
  const W=1000,H=520,pad=28;
  const canvas=document.createElement('canvas'); canvas.width=W; canvas.height=H;
  const ctx=canvas.getContext('2d');

  const g=ctx.createLinearGradient(0,0,W,H); g.addColorStop(0,'#0e2730'); g.addColorStop(1,'#0e2127');
  ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

  ctx.fillStyle='#0b1f26'; drawRoundedRect(ctx,pad,pad,W-2*pad,H-2*pad,18); ctx.fill();
  ctx.strokeStyle='#173741'; ctx.lineWidth=2; ctx.stroke();

  ctx.fillStyle='#17c8a5'; ctx.font='700 28px Inter,system-ui,Segoe UI,Arial'; ctx.fillText('Fermah Quiz ‚Ä¢ Proof-IQ', pad*1.5, pad*2.2);

  const P=140, img=new Image(); const pfpSrc=currentUser?.pfp||'';
  if(pfpSrc){ await new Promise(r=>{img.onload=r; img.onerror=r; img.src=pfpSrc;});
    ctx.save(); ctx.beginPath(); ctx.arc(pad*2+P/2,pad*4+P/2,P/2,0,Math.PI*2); ctx.closePath(); ctx.clip();
    ctx.drawImage(img,pad*2,pad*4,P,P); ctx.restore();
  }else{ ctx.fillStyle='#14333d'; ctx.beginPath(); ctx.arc(pad*2+P/2,pad*4+P/2,P/2,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#6bcfbf'; ctx.font='800 42px Inter,system-ui'; const initials=(currentUser?.name||'??').slice(0,2).toUpperCase();
    const tw=ctx.measureText(initials).width; ctx.fillText(initials,pad*2+P/2-tw/2,pad*4+P/2+14);
  }

  ctx.fillStyle='#e8f6f2'; ctx.font='800 34px Inter,system-ui'; ctx.fillText(currentUser?.name||'Player', pad*2+P+24, pad*4+40);
  ctx.fillStyle='#9fc6bb'; ctx.font='600 20px Inter,system-ui';
  ctx.fillText(`Score: ${score}/${total} ‚Ä¢ Time: ${secs}s`, pad*2+P+24, pad*4+40+34);
  ctx.fillText(new Date().toLocaleString(), pad*2+P+24, pad*4+40+34+26);

  const iqX=W-pad*2-220, iqY=pad*3.5;
  drawRoundedRect(ctx,iqX,iqY,200,120,18); ctx.fillStyle='#0a1d24'; ctx.fill(); ctx.strokeStyle='#18404a'; ctx.lineWidth=2; ctx.stroke();
  ctx.fillStyle='#9fcfbf'; ctx.font='600 16px Inter,system-ui'; ctx.fillText('PROOF-IQ', iqX+20, iqY+32);
  ctx.fillStyle='#17c8a5'; ctx.font='900 64px Inter,system-ui'; const iqTxt=String(iq); const iqW=ctx.measureText(iqTxt).width;
  ctx.fillText(iqTxt, iqX+(200-iqW)/2, iqY+92);

  ctx.fillStyle='#96cfc3'; ctx.font='14px Inter,system-ui';
  ctx.fillText('Made by FreeGuyx247 ‚Ä¢ Community fan project (not official).', pad*1.6, H-pad*1.2);

  const dataURL=canvas.toDataURL('image/png'); const blob=await (await fetch(dataURL)).blob();
  return {dataURL, blob};
}
function setupShareButtons(payload){
  const saveBtn=document.getElementById('saveCardBtn');
  const shareBtn=document.getElementById('shareBtn');
  const dl=document.getElementById('dlLink');

  saveBtn.onclick=async()=>{
    saveBtn.disabled=true; saveBtn.textContent='Building card‚Ä¶';
    const {dataURL}=await buildCardPNG(payload);
    dl.href=dataURL; dl.click();
    saveBtn.textContent='Save Card (PNG)'; saveBtn.disabled=false;
  };

  shareBtn.onclick=async()=>{
    shareBtn.disabled=true; shareBtn.textContent='Preparing‚Ä¶';
    const {blob}=await buildCardPNG(payload);
    const text=`Just played the Fermah Quiz!\nIQ ${payload.iq} ‚Ä¢ Score ${payload.score}/${payload.total} in ${payload.secs}s\n#ZK #Fermah`;
    const file=new File([blob],'fermah-quiz-card.png',{type:'image/png'});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      try{ await navigator.share({title:'Fermah Quiz', text, files:[file]}); }catch(e){}
    }else{
      window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(text),'_blank');
      const a=document.getElementById('dlLink'); a.href=URL.createObjectURL(blob); a.download='fermah-quiz-card.png'; a.click();
      alert('Your card was downloaded. Attach it to the X post.');
    }
    shareBtn.textContent='Share'; shareBtn.disabled=false;
  };
}

/* ----------------- Boot ----------------- */
document.getElementById('startBtn').addEventListener('click',startQuiz);
refreshLogin();
</script>
</body>
</html>
